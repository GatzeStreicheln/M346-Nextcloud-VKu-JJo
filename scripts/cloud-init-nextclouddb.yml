# cloud-config
# Cloud-Init Skript f√ºr NextcloudDB-Instanz
# Automatische Installation von MariaDB und Datenbank-Setup

package_update: true
package_upgrade: true

packages:
  - mariadb-server
  - mariadb-client

write_files:
  - path: /tmp/setup-db.sql
    content: |
      CREATE DATABASE IF NOT EXISTS nextcloud CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
      CREATE USER IF NOT EXISTS 'nextclouduser'@'%' IDENTIFIED BY 'jucbB6MPMWCzth';
      GRANT ALL PRIVILEGES ON nextcloud.* TO 'nextclouduser'@'%';
      FLUSH PRIVILEGES;

runcmd:
  # MariaDB bind-address auf 0.0.0.0 setzen
  - sed -i 's/bind-address.*=.*/bind-address = 0.0.0.0/' /etc/mysql/mariadb.conf.d/50-server.cnf
  
  # MariaDB neu starten
  - systemctl restart mariadb
  - systemctl enable mariadb
  
  # Root-Passwort setzen (ohne Authentifizierung)
  - mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED BY 'admin';"
  
  # Datenbank und User erstellen
  - mysql -u root -padmin < /tmp/setup-db.sql
  